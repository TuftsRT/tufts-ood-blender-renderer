#!/usr/bin/env bash

# ================================
# Configuration
# ================================
OUTPUT_DIR="<%= context.outputdir %>"
BLENDER_PROJECT="<%= context.projectfile %>"


module load modtree/deprecated
module load blender/4.2.5
module load cuda/11.7

hostname
pwd

echo "${SLURM_JOB_ID} ${SLURM_ARRAY_JOB_ID} ${SLURM_ARRAY_TASK_ID}"

# Trim whitespace and check if OUTPUT_DIR is empty or unset
if [ -z "$(echo "$OUTPUT_DIR" | xargs)" ]; then
    BLENDER_PROJECT_DIR_PATH=$(dirname "$BLENDER_PROJECT")
    OUTPUT_DIR="$BLENDER_PROJECT_DIR_PATH/output"
fi

echo "Rendering files to output directory: $OUTPUT_DIR"

if [ -z "$OUTPUT_DIR" ]; then
  echo "Error: OUTPUT_DIR is empty or unset."
  exit 1 # Exit with a non-zero status to indicate an error
fi

nvidia-smi

#Create output directory 
mkdir -p "$OUTPUT_DIR"

#render all frames, skipping existing frames (-a)
#https://docs.blender.org/manual/en/latest/advanced/command_line/arguments.html
blender -b -P ./use_gpu.py -E CYCLES $BLENDER_PROJECT --render-output $OUTPUT_DIR/###### --render-format PNG -a

#mark that we got through all the frames
touch completed

#Combine frames into video file
#/cluster/tufts/apps/manual/9/x86_64/blender/4.5.4/blender-4.5.4-linux-x64/tools/ffmpeg-linux-amd64

module load ffmpeg
ffmpeg -r 24 -i $OUTPUT_DIR/%06d.png  -c:v mpeg4  "$OUTPUT_DIR/video.mp4"

#ffmpeg -r 24 -pattern_type glob -i $OUTPUT_DIR/*.png -c:v h264 -crf 20 -g 18 -vf pad=ceil(iw/2)*2:ceil(ih/2)*2 -pix_fmt yuv420p -r 24 -y -r 24 "$OUTPUT_DIR/video.mp4"


echo "Exited.  End of job ${SLURM_JOB_ID}."
echo "Output at: ${OUTPUT_DIR}"